---
title: "pcl_interobserver_test_nmnh"
author: "Amy Anderson"
date: "10/15/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### This script is intended to compare results of pathology assessment of porous cranial lesions from multiple viewing modalities ( 1) direct observation, 2)photos and 3) CT scans) by 3 separate observers.
In it I calculate percent agreement (within-modality across observers, and within-observer across modalities)

Data are the work of Anderson, Sutherland, and Campbell (2019). CT scans from which the data are drawn are courtesy of Dave Hunt and the Smithsonian National Museum of Natural History, and the Tsimane Health and Life History Project in collaboration with the Horus Group.

```{r, warnings  = FALSE}
# load necessary packages
library(tidyverse)
library(janitor)
library(tidyr)
library(irr)
```


#### Load in the data files
```{r}
anon_key <- read_csv("nmnh_anonymize_key.csv")

aa_direct <- read_csv("anderson_nmnh_direct_observation.csv") %>%
  clean_names()

aa_photos <- read_csv("anderson_nmnh_photo_scores.csv") %>%
  clean_names()
gc_photos <- read_csv("campbell_nmnh_scores_photos.csv") %>%
clean_names()
#ls_photos <- read_csv("linda's scores.csv")

aa_scans <- read_csv("anderson_nmnh_scans.csv") %>%
  clean_names()
gc_scans <- read_csv("campbell_nmnh_scans - campbell_nmnh_scans.csv") %>%
  clean_names()
#ls_scans <- read_csv("linda's scans.csv")



```
### Data Wrangling
I want to combine all scores into a single data frame. For tidy data, I need an 'observer' column and a 'modality' column. For most IRR analyses I want binary presence/absence data. 

1. Combine data frames by merging on cranial ID
2. Mutate: 
 - create an 'observer' variable
 - create a variable for each modality frame specifying modality (photo, 2d etc.)
3. gather modality variables (2d, 3d, photo, direct) into one 'modality' column
4. Mutate:
 - create a binary from 'direct score'
 
??3. code modality as a factor


#### First, before merging data frames,
make sure all data frames share variable names and classes for key columns

Clean and wrangle Anderson's data

```{r}

## Anonymization key. 
#
anon_key <- anon_key %>%
  filter(anonymized_id != "H") %>% # remove erroneous "H" designation (refers to nothing) 
rename(cranium_id = anonymized_id) %>%
  mutate(nmnh_id = as.character(nmnh_id))



## Direct observation scores (Anderson)
aa_direct <- aa_direct %>%
  rename("nmnh_id" = "specimen_no") %>% #rename ID variable match other data frames
  mutate(nmnh_id = as.character(nmnh_id),
         observer = "aa") %>% # create Observer variable
  rename(orbit_score_direct = orbit_score,
         vault_score_direct = vault_score) %>%
  # retain only useful columns
  select(nmnh_id, 
         sex, 
         age, 
         orbit_score_direct, 
         vault_score_direct, 
         observer) 



## Anderson's scores from photos 
#
aa_photos <- aa_photos %>%
  filter(cranium_id != "H") %>%
 mutate(orbit_score = replace_na(orbit_score, 0)) %>% # replace NAs with 0's. There aren't photos b/c I didn't take photos of non-pathological orbits
 mutate(observer = "aa")%>% # create Observer variable
rename(orbit_score_photo = orbit_score,
       vault_score_photo = vault_score)
  

## Anderson's scores from scans
#
aa_scans <- aa_scans %>%
  mutate(nmnh_id = as.character(cranium_id)) %>%
  mutate(observer = "aa") %>%
  rename(orbit_score_scan = rinaldo_score_co,
         vault_score_scan = rinaldo_score_ph) %>%
  select(c("nmnh_id", 
           "x2d_max_calvarial_width",
           "x2d_radial_diploe":"x2d_calvarial_surface_discontinuity",
           "x2d_orbital_marrow_width":"x3d_ph_visible",
           "vault_score_scan",
           "x3d_co_visible", 
           "observer",
           "orbit_score_scan")) 



## Merge all of Anderson's scores from all modalities
aa_scores<- anon_key %>%
  inner_join(aa_direct, by = "nmnh_id") %>%
  inner_join(aa_photos, by = "cranium_id") %>%
  inner_join(aa_scans, by = "nmnh_id")  
```



#### Clean and wrangle data from Campbell's observations

```{r}
# clean and filter Campbell scan observations to merge with other data
gc_scores <- gc_scans %>%
  rename(cranium_id = "x0",
  "x2d_orbital_roof_discontinuity" = "x2d_orbital_marrow_width",
  "x2d_orbital_marrow_width" =  "x2d_orbital_roof_discontinuity", # data entry for these two variables was clearly switched in the raw data file
  orbit_score_scan = rinaldo_score_co) %>%
  mutate(nmnh_id = as.character(cranium_id),
         observer = "gc",
         orbit_direct_score = NA,
         vault_score_scan = as.numeric(rinaldo_score_ph)) %>% 
   select(c("nmnh_id", 
           "x2d_max_calvarial_width",
           "x2d_radial_diploe":"x2d_calvarial_surface_discontinuity",
           "x2d_orbital_marrow_width":"x3d_ph_visible",
           "vault_score_scan",
           "x3d_co_visible", 
           "observer",
           "orbit_score_scan")) %>%
  inner_join(anon_key) %>% # connect anonymization key
  inner_join(gc_photos) # add photo scores



```

#### Combine data from all observers into a single data frame
and create tidy data (!!!)
```{r}

```



Presence/Absence IRR can be calculated for pairs of observers (Cohen's kappa, unweighted) or across multiple observers (Fleiss's kappa).

IRR of ordinal scores can only be calculated for pairs of observers, using a weighted Cohen's kappa

Calculate IRR for Anderson's and Campbell's presence/absence scores (Cohen's kappa)
```{r}
# Cohen's k for orbit photo scores (presence/absence)

```




Now, calculate the percent agreement between Anderson's and Campbell's scores for each modality - first presence/absence, then full scores
```{r}

```




## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
