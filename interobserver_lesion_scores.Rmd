---
title: "pcl_interobserver_test_nmnh"
author: "Amy Anderson"
date: "10/15/2019"
output: html_document
---
still need to look up again how to stop Rmd from printing out all the sausage-making....
```{r setup}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

This script is intended to compare results of pathology assessment of porous cranial lesions from multiple viewing modalities ( 1) direct observation, 2)photos and 3) CT scans) by 3 separate observers.

In it I calculate percent agreement (within-modality across observers, and within-observer across modalities)

Data are the work of Anderson, Sutherland, and Campbell (2019). CT scans from which the data are drawn are courtesy of Dave Hunt and the Smithsonian National Museum of Natural History, and the Tsimane Health and Life History Project in collaboration with the Horus Group.

```{r, include = FALSE}
# load necessary packages
library(tidyverse)
library(janitor)
library(tidyr)
library(irr)
```


#### Load in the data files:
- anonymization key (so that observers do not connect cranium ID from photos to cranium ID when viewing scans)
- Anderson's direct observation scores

- Anderson's photo scores
- Campbell's photo scores
- Sutherland's photo scores

- Anderson's scan scores
- Campbell's scan scores
- Sutherland's scan scores
```{r, include=FALSE}
anon_key <- read_csv("nmnh_anonymize_key.csv")

aa_direct <- read_csv("anderson_nmnh_direct_observation.csv") %>%
  clean_names()

aa_photos <- read_csv("anderson_nmnh_photo_scores.csv") %>%
  clean_names()
gc_photos <- read_csv("campbell_nmnh_scores_photos.csv") %>%
clean_names()
ls_photos <- read_csv("linda_sutherland_photo_scores - Sheet1.csv")

aa_scans <- read_csv("anderson_nmnh_scans.csv") %>%
  clean_names()
gc_scans <- read_csv("campbell_nmnh_scans - campbell_nmnh_scans.csv") %>%
  clean_names()
#ls_scans <- read_csv("linda's scans.csv")



```
## Data Wrangling
I want to combine all scores into a single data frame. For tidy data, I need an 'observer' column and a 'modality' column. For most IRR analyses I want binary presence/absence data. 

1. Clean names across multiple spreadsheets
2. Mutate: 
 - create an 'observer' variable
 - create a variable for each modality frame specifying modality (photo, 2d etc.)
3. Make data long: gather modality variables (2d, 3d, photo, direct) into one 'modality' column
4. Combine data frames by merging on cranial ID
5. Mutate: create a binary presence/absence score 
 



#### Clean/wrangle Anonymization Key, *Anderson's Direct Observation data*
```{r}
## Anonymization key. 
anon_key <- anon_key %>%
  filter(anonymized_id != "H") %>% # remove erroneous "H" designation (refers to nothing) 
rename(cranium_id = anonymized_id) %>%
  mutate(nmnh_id = as.character(nmnh_id))


## Direct observation scores (Anderson)
aa_direct<- aa_direct %>%
  rename("nmnh_id" = "specimen_no") %>% #rename ID variable match other data frames
  mutate(nmnh_id = as.character(nmnh_id),
         modality = "direct",
         observer = "aa") %>% # create 'modality' variable

    
## transform data to 'long' rather than 'wide'
  pivot_longer(cols = c(orbit_score, vault_score), names_to = "criterion", values_to = "score") %>%
  #rename(orbit_score_direct = orbit_score,
      #   vault_score_direct = vault_score) %>%
  # retain only useful columns
  select(nmnh_id, 
         sex, 
         age, 
         criterion,
         score,
         modality, 
         observer) 

```



#### Clean/wrangle *Anderson's Photo data*
```{r}
## lots to tidy here
aa_photos <- aa_photos %>%
  filter(cranium_id != "H") %>%
 mutate(orbit_score = replace_na(orbit_score, 0)) %>% # replace NAs with 0's. There aren't photos b/c I didn't take photos of non-pathological orbits
 mutate(modality = "photo", # create modality variable
      observer = "aa")%>%
  pivot_longer(cols = c(orbit_score, 
                        vault_score), 
               names_to = "criterion", 
               values_to = "score") 
```


#### Clean/wrangle *Anderson's Scan data*
```{r}
## Anderson's scores from scans
aa_scans <- aa_scans %>%
  mutate(nmnh_id = as.character(cranium_id)) %>% # numeric museum catalog ID is parsed as a numeric. Change that.
  mutate(observer = "aa") %>%
  rename(orbit_score = rinaldo_score_co,
         vault_score = rinaldo_score_ph) %>%
  # put all cranial measurements in 'long format'
  pivot_longer(cols = c(x2d_max_calvarial_width,
                        x2d_orbital_marrow_width), 
               names_to = "measurement", 
               values_to = "mm") %>%
# group all presence/absence and ordinal indices together in 'long' format
pivot_longer(cols = c(x2d_radial_diploe:x2d_calvarial_surface_discontinuity,
                      x2d_orbital_roof_discontinuity, 
                      x3d_ph_visible, 
                      vault_score,
                      x3d_co_visible, 
                      orbit_score), 
             names_to = "criterion", 
             values_to = "score") %>%
# remove columns with general context and notes
  select(-(x2d_max_width_bone:general_notes)) %>%
# specify 2d or 3d modality based on the criterion in a row
  mutate(modality = if_else(grepl('^x2d', criterion), "scan_2d", "scan_3d"))
  
```



#### Join all modality data frames into a single data frame in tidy format of *All Anderson Data*
```{r}
## Tidy dataframe for each modality
aa_direct_tidy <-anon_key %>%
  inner_join(aa_direct, by = "nmnh_id")%>%
    select(nmnh_id, 
           cranium_id,
           modality,
           criterion,
           score,
           observer)
  
  aa_photos_tidy <- anon_key %>%
  inner_join(aa_photos, by = "cranium_id") 
  
  aa_scans_tidy <- anon_key %>%
  inner_join(aa_scans, by = "nmnh_id") %>%
    rename(cranium_id = cranium_id.x) %>%
    select(nmnh_id,
           cranium_id,
           modality,
           criterion,
           score,
           observer)
  
  
## merge Anderson data for all three modalities:
  aa_scores <- rbind(aa_direct_tidy, aa_photos_tidy, aa_scans_tidy) %>%
# and create a binary presence/absence version for all criteria
    mutate(score_binary = if_else(score >= 1, 1, 0))  

  
```


Now done wrangling Anderson's observations (Observer 1). 
Moving on to Cambpell (Observer 2).

#### Clean and wrangle data from *Campbell's observations: Photos and Scans*

```{r}
## clean and filter Campbell scan observations to merge with photo data
gc_photos <- gc_photos %>%
mutate(modality = "photo")


gc_scores <- gc_scans %>%
  rename("x2d_orbital_roof_discontinuity" = "x2d_orbital_marrow_width",
  "x2d_orbital_marrow_width" =  "x2d_orbital_roof_discontinuity", 
# data entry for these two variables was clearly switched in the raw data file
  orbit_score_scan = rinaldo_score_co,
vault_score_scan = rinaldo_score_ph) %>%
  mutate(nmnh_id = as.character(x0),
         observer = "gc",
         orbit_score_direct = NA, # populate this variable to prep for merging with Anderson data
         vault_score_direct = NA) %>% 
# connect anonymization key
  inner_join(anon_key) %>% 
# add photo scores
  inner_join(gc_photos) %>% 
# consistent naming structure: anatomical area_score_modality
  rename(orbit_score_photo = orbit_photo_score,
         vault_score_photo = vault_photo_score) %>%
# make it tidy: a column for 'criterion' and a column with the score for each instance of each criterion observed
  pivot_longer(cols = c(x2d_radial_diploe:x2d_calvarial_surface_discontinuity,
                      x2d_orbital_roof_discontinuity, 
                      x3d_ph_visible, 
                      vault_score_scan,
                      x3d_co_visible, 
                      orbit_score_scan,
                      orbit_score_direct,
                      vault_score_direct,
                      orbit_score_photo,
                      vault_score_photo), 
               names_to = "criterion", 
               values_to = "score") %>%
# all entries from scans have 'scan' as the modality. Separate 2d and 3d based on the criteria specific to that modality (now I'm glad I started all my 2d variables with '2d')
mutate(modality = if_else(grepl('^x2d', criterion), # note: ^ = 'starts with'
                                "scan_2d", 
                                "scan_3d")) %>%
   select(c("nmnh_id", 
           "criterion",
           "score",
           "observer",
           "modality",
           "x2d_orbital_marrow_width", # keep these measures two, for later exploration
           "x2d_max_calvarial_width")) %>%
# finally, create an entirely binary presence/absence version of all criteria scores
  mutate(binary_score = if_else(score >0, 1, 0))

```


#### Clean and Wrangle *Sutherland's photo and scan data*:

```{r}
## Sutherland photo data (scan data coming shortly)
ls_photos_tidy <- ls_photos%>%
  filter(cranium != "h") %>%
  rename(cranium_id = cranium,
         vault_score_photo = ph_rinaldo_score,
         orbit_score_photo = co_rinaldo_score) %>%
  mutate(cranium_id = toupper(cranium_id),
         modality = "photo",
         observer = "ls") %>%
   inner_join(anon_key) %>%
  pivot_longer(cols = c(vault_score_photo,
                        orbit_score_photo),
               names_to = "criterion",
               values_to = "score") %>%
  # create binary presence/absence version of all criteria scores
  mutate(binary_score = if_else(score >= 1, 1, 0))

#mutate(vault_photo_binary = if_else(vault_photo_score > 0, 1, 0),
        # orbit_photo_binary = if_else(orbit_photo_score >= 1, 1, 0)) %>%# REMEMBER!!! lots of NA's (missing photos) get turned to zeros here: don't analyze orbital data yet. % Agreement will be artificially inflated.
# BUT the NAs are being turned to 1's and I don't understand why....
```



Calculate intra-observer IRR for each observer
```{r}

```




rater.bias() function in the irr package will calculate systematic bias between two observers. <-- use this!

#### Combine data from all observers into a single data frame
and create tidy data (!!!)
```{r}

# select only columns from Anderson data that match Campbell data

```



Now that you have clean data for all of Anderson's observations, take a look at intra-observer agreement across modalities.

The first stat of interest is agreement of presence/absence data across direct observation, photos, 2D MPR, and 3D reconstruction
```{r}

```
```



Presence/Absence IRR can be calculated for pairs of observers (Cohen's kappa, unweighted) or across multiple observers (Fleiss's kappa).

IRR of ordinal scores can only be calculated for pairs of observers, using a weighted Cohen's kappa

Calculate IRR for Anderson's and Campbell's presence/absence scores (Cohen's kappa)
```{r}
# Cohen's k for orbit photo scores (presence/absence)

```




Now, calculate the percent agreement between Anderson's and Campbell's scores for each modality - first presence/absence, then full scores
```{r}


```




